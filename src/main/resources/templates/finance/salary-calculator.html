<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Calculator - Payroll System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #343a40;
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: #f8f9fa;
            padding: 0.75rem 1.5rem;
        }
        .sidebar .nav-link.active {
            color: #fff;
            background-color: #0d6efd;
        }
        .sidebar .nav-link:hover {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        main {
            padding-top: 56px;
        }
        .navbar-brand {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            background-color: rgba(0, 0, 0, 0.25);
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25);
        }
        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            height: 100%;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .table-finance th, .table-finance td {
            vertical-align: middle;
        }
        .action-column {
            width: 150px;
        }
        .filter-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .btn-calculate {
            background-color: #6610f2;
            border-color: #6610f2;
        }
        .btn-calculate:hover {
            background-color: #520dc2;
            border-color: #520dc2;
        }
        .selection-row {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Payroll System</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="dropdown text-end me-3">
            <a href="#" class="d-block link-light text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle me-1"></i> <span th:text="${financeOfficer != null ? financeOfficer.name : 'Finance Officer'}">Finance Officer</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end text-small" aria-labelledby="userDropdown">
                <li><a class="dropdown-item" href="/logout">Sign out</a></li>
            </ul>
        </div>
    </header>
    
    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/finance/dashboard">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/finance/employees">
                                <i class="bi bi-people"></i> Employee Details
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/finance/payslips">
                                <i class="bi bi-receipt"></i> Payslips
                            </a>
                        </li>
                        
                        <li class="nav-item">
                            <a class="nav-link active" href="/finance/salary-calculator">
                                <i class="bi bi-calculator"></i> Salary Calculator
                            </a>
                        </li>
                        
                    </ul>
                </div>
            </nav>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2"><i class="bi bi-calculator me-2 text-primary"></i>Salary Calculator</h1>
                </div>
                
                <div th:if="${success}" class="alert alert-success" th:text="${success}">
                </div>
                
                <div th:if="${error}" class="alert alert-danger" th:text="${error}">
                </div>
                
                <!-- Filter Section -->
                <div class="filter-card mb-4">
                    <form action="/finance/salary-calculator/calculate" method="post" id="calculationForm">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label for="month" class="form-label">Month</label>
                                <select class="form-select" id="month" name="month" required>
                                    <option value="" selected disabled>Select Month</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="year" class="form-label">Year</label>
                                <select class="form-select" id="year" name="year" required>
                                    <option value="" selected disabled>Select Year</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="department" class="form-label">Department (Optional)</label>
                                <select class="form-select" id="department" name="departmentId">
                                    <option value="">All Departments</option>
                                    <option th:each="dept : ${departments}" th:value="${dept.id}" th:text="${dept.name}">IT</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="filterButton" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-funnel me-1"></i> Filter Employees
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Employee Selection Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="fs-5">Select Employees for Salary Calculation</span>
                            <div>
                                <button id="selectAllBtn" class="btn btn-sm btn-outline-secondary me-2">
                                    <i class="bi bi-check-all me-1"></i> Select All
                                </button>
                                <button id="deselectAllBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-x-lg me-1"></i> Deselect All
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover table-finance" id="employeeTable">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAll">
                                            </div>
                                        </th>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Job Title</th>
                                        <th>Employment Type</th>
                                        <th>Join Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- This would be populated with data from the backend -->
                                    <tr th:each="employee : ${employees}" th:id="'emp-' + ${employee.employeeID}">
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input employee-select" type="checkbox" 
                                                       th:value="${employee.employeeID}" 
                                                       name="selectedEmployees">
                                            </div>
                                        </td>
                                        <td th:text="${employee.employeeID}">EMP001</td>
                                        <td th:text="${employee.FullName}">John Doe</td>
                                        <td th:text="${employee.department != null ? employee.department.name : 'Not Assigned'}">IT</td>
                                        <td th:text="${employee.jobTitle}">Software Engineer</td>
                                        <td>
                                            <span th:if="${employee.isPartTime()}" class="badge bg-info">Part-Time</span>
                                            <span th:if="${!employee.isPartTime()}" class="badge bg-primary">Full-Time</span>
                                        </td>
                                        <td th:text="${#temporals.format(employee.joiningDate, 'dd MMM yyyy')}">01 Jan 2023</td>
                                    </tr>
                                    <tr th:if="${employees == null || employees.empty}">
                                        <td colspan="7" class="text-center">No employees found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-3">
                            <button id="calculateBtn" class="btn btn-calculate text-white" disabled>
                                <i class="bi bi-calculator me-1"></i> Calculate Salary
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Section (Initially Hidden) -->
                <div id="resultsSection" class="my-4" style="display: none;">
                    <h3>Calculation Results</h3>
                    <div class="card">
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i> Salary calculations completed for the selected employees for 
                                <span id="resultPeriod">April 2025</span>.
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-finance" id="resultsTable">
                                    <thead>
                                        <tr>
                                            <th>Employee ID</th>
                                            <th>Name</th>
                                            <th>Basic Salary</th>
                                            <th>Allowances</th>
                                            <th>Overtime Pay</th>
                                            <th>Bonuses</th>
                                            <th>Deductions</th>
                                            <th>Net Salary</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody">
                                        <!-- This will be populated via JavaScript after calculation -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button class="btn btn-outline-success" onclick="confirmAndSaveSalaries()">
                                    <i class="bi bi-check-circle me-1"></i> Confirm & Save
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Helper function to get month name (moved outside document ready for global access)
function getMonthName(monthNum) {
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    return months[parseInt(monthNum) - 1];
}

// Global variable to store calculation IDs for saving
let calculationIds = [];

// Function to handle the "Confirm & Save" button click
function confirmAndSaveSalaries() {
    // Check if we have valid calculation IDs
    if (!calculationIds || calculationIds.length === 0) {
        alert('No valid calculation IDs to save. Please recalculate salaries.');
        return;
    }
    
    // Filter out any null or undefined IDs
    const validIds = calculationIds.filter(id => id != null);
    
    if (validIds.length === 0) {
        alert('No valid calculation IDs to save. Please recalculate salaries.');
        return;
    }
    
    // Disable the button to prevent multiple clicks
    const saveButton = document.querySelector('.btn-outline-success');
    const originalBtnText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Saving...';
    saveButton.disabled = true;
    
    // Prepare data to send to the server
    const data = {
        calculationIds: validIds
    };
    
    console.log('Sending calculation IDs:', validIds);
    
    // Make AJAX call to save the calculations
    fetch('/finance/salary-calculator/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content // Include CSRF token if using Spring Security
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        // Try to parse JSON even if status is not OK
        return response.text().then(text => {
            if (text) {
                try {
                    return { ok: response.ok, data: JSON.parse(text) };
                } catch (e) {
                    console.error('Failed to parse JSON:', e);
                    return { ok: response.ok, error: text };
                }
            }
            return { ok: response.ok, error: response.statusText };
        });
    })
    .then(result => {
        // Reset button
        saveButton.innerHTML = originalBtnText;
        saveButton.disabled = false;
        
        if (result.ok && result.data && result.data.success) {
            // Show success message
            const resultsSection = document.getElementById('resultsSection');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success mt-3';
            successAlert.innerHTML = '<i class="bi bi-check-circle me-2"></i>' + result.data.message;
            
            // Insert the alert at the beginning of the results section
            resultsSection.insertBefore(successAlert, resultsSection.firstChild);
            
            // Remove the alert after 5 seconds
            setTimeout(() => {
                successAlert.remove();
            }, 5000);
        } else {
            // Handle error
            console.error('Server error:', result);
            let errorMessage = 'Unknown error occurred';
            
            if (result.data && result.data.error) {
                errorMessage = result.data.error;
            } else if (result.error) {
                errorMessage = result.error;
            }
            
            alert('Error: ' + errorMessage);
        }
    })
    .catch(error => {
        // Reset button
        saveButton.innerHTML = originalBtnText;
        saveButton.disabled = false;
        
        console.error('Error:', error);
        alert('Error occurred while saving salary calculations: ' + error.message);
    });
}

// Function to view calculation details
function viewCalculationDetails(calculationId) {
    // Debug
    console.log('Viewing calculation details for ID:', calculationId);
    
    // Check if calculationId is valid
    if (!calculationId) {
        alert('Error: Invalid calculation ID');
        return;
    }
    
    // Create and show a modal for displaying the details
    let detailsModal = document.getElementById('calculationDetailsModal');
    
    // If the modal doesn't exist, create it
    if (!detailsModal) {
        const modalHTML = `
            <div class="modal fade" id="calculationDetailsModal" tabindex="-1" aria-labelledby="calculationDetailsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="calculationDetailsModalLabel">Salary Calculation Details</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="calculationDetailsBody">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading calculation details...</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Append the modal to the body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        detailsModal = document.getElementById('calculationDetailsModal');
    }
    
    // Get the modal body where details will be displayed
    const modalBody = document.getElementById('calculationDetailsBody');
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading calculation details...</p>
        </div>
    `;
    
    // Create a Bootstrap modal instance and show it
    const modal = new bootstrap.Modal(detailsModal);
    modal.show();
    
    // Fetch the calculation details from the server
    fetch(`/finance/salary-calculator/details/${calculationId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Render the details in the modal
                renderCalculationDetails(data.details, modalBody);
            } else {
                // Handle error
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i> 
                        ${data.error || 'Error retrieving calculation details'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i> 
                    Error fetching calculation details: ${error.message}
                </div>
            `;
        });
}

// Function to render calculation details in the modal
function renderCalculationDetails(details, modalBody) {
    const employee = details.employee;
    const earnings = details.earnings;
    const deductions = details.deductions;
    const summary = details.summary;
    const metadata = details.metadata;
    
    // Format date string helper function
    const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        }).format(date);
    };
    
    // Format currency helper function
    const formatCurrency = (amount) => {
        return '₹' + (parseFloat(amount) || 0).toLocaleString('en-IN', {
            maximumFractionDigits: 2,
            minimumFractionDigits: 2
        });
    };
    
    // Create the HTML for the modal content
    const detailsHTML = `
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Employee Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Employee ID:</strong> ${employee.employeeID}</p>
                                <p><strong>Name:</strong> ${employee.name}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Designation:</strong> ${employee.designation}</p>
                                <p><strong>Department:</strong> ${employee.department}</p>
                                <p><strong>Employment Type:</strong> ${employee.isPartTime ? 'Part-Time' : 'Full-Time'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">Earnings</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>Basic Salary</td>
                                    <td class="text-end">${formatCurrency(earnings.basicSalary)}</td>
                                </tr>
                                <tr>
                                    <td>Allowances</td>
                                    <td class="text-end">${formatCurrency(earnings.allowances)}</td>
                                </tr>
                                <tr>
                                    <td>Overtime Pay</td>
                                    <td class="text-end">${formatCurrency(earnings.overtimePay)}</td>
                                </tr>
                                <tr>
                                    <td>Bonus</td>
                                    <td class="text-end">${formatCurrency(earnings.bonus)}</td>
                                </tr>
                                <tr class="table-success">
                                    <th>Total Earnings</th>
                                    <th class="text-end">${formatCurrency(earnings.totalEarnings)}</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">Deductions</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>Income Tax</td>
                                    <td class="text-end">${formatCurrency(deductions.incomeTax)}</td>
                                </tr>
                                <tr>
                                    <td>Provident Fund</td>
                                    <td class="text-end">${formatCurrency(deductions.providentFund)}</td>
                                </tr>
                                <tr>
                                    <td>Other Deductions</td>
                                    <td class="text-end">${formatCurrency(deductions.otherDeductions)}</td>
                                </tr>
                                <tr class="table-danger">
                                    <th>Total Deductions</th>
                                    <th class="text-end">${formatCurrency(deductions.totalDeductions)}</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-12 mb-3">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Salary Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>Pay Period:</strong> ${summary.payPeriod}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Gross Salary:</strong> ${formatCurrency(summary.grossSalary)}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Net Salary:</strong> <span class="text-primary fw-bold">${formatCurrency(summary.netSalary)}</span></p>
                            </div>
                        </div>
                        
                        ${details.hraExemption !== undefined ? `
                        <div class="mt-3 pt-3 border-top">
                            <h6>HRA Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>HRA Exemption:</strong> ${formatCurrency(details.hraExemption)}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Taxable HRA:</strong> ${formatCurrency(details.taxableHra)}</p>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <div class="col-md-12">
                <div class="card border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="card-title mb-0">Calculation Metadata</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Status:</strong> <span class="badge ${metadata.status === 'APPROVED' ? 'bg-success' : 'bg-warning'}">${metadata.status || 'DRAFT'}</span></p>
                                <p><strong>Created By:</strong> ${metadata.createdBy || 'System'}</p>
                                <p><strong>Created At:</strong> ${formatDate(metadata.createdAt)}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Last Modified By:</strong> ${metadata.lastModifiedBy || 'N/A'}</p>
                                <p><strong>Last Modified At:</strong> ${formatDate(metadata.lastModifiedAt)}</p>
                                <p><strong>Remarks:</strong> ${metadata.remarks || 'No remarks'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Update the modal content
    modalBody.innerHTML = detailsHTML;
}

// Function to display calculation results from the server
function displayCalculationResults(data, month, year) {
    // Reset the calculationIds array
    calculationIds = [];
    
    // Debug
    console.log('Processing calculation results');
    
    // Set the period in the results section
    document.getElementById('resultPeriod').textContent = data.period || `${getMonthName(month)} ${year}`;
    
    // Clear previous results
    const resultsTableBody = document.getElementById('resultsTableBody');
    resultsTableBody.innerHTML = '';
    
    // Add data for each calculation
    data.calculationResults.forEach(calculation => {
        // Debug
        console.log('Processing calculation:', calculation);
        
        // Store the calculation ID for saving later
        if (calculation.id) {
            console.log('Adding calculation ID to save list:', calculation.id);
            calculationIds.push(calculation.id);
        } else {
            console.log('Warning: Calculation has no ID');
        }
        
        const newRow = document.createElement('tr');
        
        // Check if calculation ID exists before adding the onclick attribute
        const viewDetailsButton = calculation.id ? 
            `<button class="btn btn-sm btn-outline-info" title="View Details" onclick="viewCalculationDetails(${calculation.id})">
                <i class="bi bi-eye"></i>
            </button>` : 
            `<button class="btn btn-sm btn-outline-info" title="View Details" disabled>
                <i class="bi bi-eye"></i>
            </button>`;
        
        newRow.innerHTML = `
            <td>${calculation.employee.employeeID || ''}</td>
            <td>${calculation.employee.FullName || ''}</td>
            <td>₹${calculation.basicSalary.toLocaleString()}</td>
            <td>₹${calculation.allowances.toLocaleString()}</td>
            <td>₹${calculation.overtimePay.toLocaleString()}</td>
            <td>₹${calculation.bonus.toLocaleString()}</td>
            <td>₹${(calculation.incomeTax + calculation.providentFund + calculation.otherDeductions).toLocaleString()}</td>
            <td><strong>₹${calculation.netSalary.toLocaleString()}</strong></td>
            <td>
                <div class="btn-group" role="group">
                    ${viewDetailsButton}
                </div>
            </td>
        `;
        resultsTableBody.appendChild(newRow);
    });
    
    // Debug
    console.log('Calculation IDs collected:', calculationIds);
    
    // Show the results section
    document.getElementById('resultsSection').style.display = 'block';
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

document.addEventListener('DOMContentLoaded', function() {
    // Select All checkbox functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const employeeCheckboxes = document.querySelectorAll('.employee-select');
    const calculateBtn = document.getElementById('calculateBtn');
    
    // Select All button
    document.getElementById('selectAllBtn').addEventListener('click', function() {
        selectAllCheckbox.checked = true;
        employeeCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        updateCalculateButton();
    });
    
    // Deselect All button
    document.getElementById('deselectAllBtn').addEventListener('click', function() {
        selectAllCheckbox.checked = false;
        employeeCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateCalculateButton();
    });
    
    // Select All checkbox
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = selectAllCheckbox.checked;
        employeeCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateCalculateButton();
    });
    
    // Individual checkboxes
    employeeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllCheckbox();
            updateCalculateButton();
        });
    });
    
    // Update select all checkbox state
    function updateSelectAllCheckbox() {
        const allChecked = Array.from(employeeCheckboxes).every(checkbox => checkbox.checked);
        const someChecked = Array.from(employeeCheckboxes).some(checkbox => checkbox.checked);
        
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }
    
    // Enable/disable calculate button
    function updateCalculateButton() {
        const anyChecked = Array.from(employeeCheckboxes).some(checkbox => checkbox.checked);
        calculateBtn.disabled = !anyChecked;
    }
    
    // Filter button functionality
    document.getElementById('filterButton').addEventListener('click', function() {
        // In a real app, this would trigger an AJAX call to refresh the employee list
        // Here we'll just simulate it with an alert
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        const department = document.getElementById('department').value;
        
        if (!month || !year) {
            alert('Please select both month and year to filter employees');
            return;
        }
        
        alert(`Filtered for ${getMonthName(month)} ${year}${department ? ' and selected department' : ''}`);
        // In real implementation, this would refresh the table with filtered employees
    });
    
    // Calculate button functionality
    calculateBtn.addEventListener('click', function() {
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        
        if (!month || !year) {
            alert('Please select both month and year before calculating');
            return;
        }
        
        // Get selected employees
        const selectedEmployees = [];
        employeeCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedEmployees.push(checkbox.value);
            }
        });
        
        if (selectedEmployees.length === 0) {
            alert('Please select at least one employee');
            return;
        }
        
        // Show loading indicator
        const calculateBtn = document.getElementById('calculateBtn');
        const originalBtnText = calculateBtn.innerHTML;
        calculateBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Calculating...';
        calculateBtn.disabled = true;
        
        // Prepare data to send to the server
        const data = {
            month: month,
            year: year,
            selectedEmployees: selectedEmployees
        };
        
        // Make AJAX call to the backend
        fetch('/finance/salary-calculator/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content // Include CSRF token if using Spring Security
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Reset button
            calculateBtn.innerHTML = originalBtnText;
            calculateBtn.disabled = false;
            
            if (data.success) {
                // Display results
                displayCalculationResults(data, month, year);
            } else {
                // Handle error
                alert('Error: ' + (data.error || 'Unknown error occurred'));
            }
        })
        .catch(error => {
            // Reset button
            calculateBtn.innerHTML = originalBtnText;
            calculateBtn.disabled = false;
            
            console.error('Error:', error);
            alert('Error occurred while calculating salaries. Please try again.');
        });
    });
    
    // Helper function to show dummy results (for testing/demo purposes)
    function showDummyResults(month, year, employeeIds) {
        // Set the period in the results section
        document.getElementById('resultPeriod').textContent = `${getMonthName(month)} ${year}`;
        
        // Clear previous results
        const resultsTableBody = document.getElementById('resultsTableBody');
        resultsTableBody.innerHTML = '';
        
        // Add dummy data for each selected employee
        employeeIds.forEach(empId => {
            const empRow = document.querySelector(`#emp-${empId}`);
            if (empRow) {
                const empName = empRow.cells[2].textContent;
                
                // Generate random salary components
                const basicSalary = Math.floor(Math.random() * 50000) + 30000;
                const allowances = Math.floor(Math.random() * 10000) + 5000;
                const overtimePay = Math.floor(Math.random() * 5000); // Added overtime pay
                const bonus = Math.floor(Math.random() * 3000); // Added bonus
                const deductions = Math.floor(Math.random() * 8000) + 3000;
                const netSalary = basicSalary + allowances + overtimePay + bonus - deductions;
                
                // Create a new row for the results table
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${empId}</td>
                    <td>${empName}</td>
                    <td>₹${basicSalary.toLocaleString()}</td>
                    <td>₹${allowances.toLocaleString()}</td>
                    <td>₹${overtimePay.toLocaleString()}</td>
                    <td>₹${bonus.toLocaleString()}</td>
                    <td>₹${deductions.toLocaleString()}</td>
                    <td><strong>₹${netSalary.toLocaleString()}</strong></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-info" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                resultsTableBody.appendChild(newRow);
            }
        });
        
        // Show the results section
        document.getElementById('resultsSection').style.display = 'block';
        
        // Scroll to results
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }
});
    </script>
</body>
</html>